<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <title>Libri</title>
    <style>
        body { font-family: sans-serif; padding: 20px; }
        input { margin: 5px 0; padding: 7px; width: 100%; }
        button { padding: 10px; margin: 5px 0; width: 100%; }
        .book { padding: 10px; border-bottom: 1px solid #ccc; }
        .delete-btn { background: red; color: white; padding: 5px; border: none; cursor: pointer; }
    </style>
</head>
<body>

    <h2>Controlla libro</h2>
    <input id="searchInput" placeholder="Titolo da cercare">
    <button id="searchBtn">Cerca</button>
    <div id="searchResult"></div>

    <h2>Aggiungi libro</h2>
    <input id="newTitle" placeholder="Titolo">
    <input id="newAuthor" placeholder="Autore">
    <input id="newStore" placeholder="Libreria">
    <button id="addBtn">Aggiungi Libro</button>
    <div id="addStatus"></div>

    <h2>Lista libri</h2>
    <button id="refreshBtn">Aggiorna lista</button>
    <div id="bookList"></div>

<script>
// URL API Vercel (serverless)
const API_URL = "/api/books";

// CERCA
document.getElementById("searchBtn").onclick = async () => {
    const query = document.getElementById("searchInput").value.trim();
    if (!query) return;

    const res = await fetch(API_URL + "?search=" + encodeURIComponent(query));
    const data = await res.json();

    const box = document.getElementById("searchResult");
    if (data.length === 0) {
        box.innerHTML = "<p style='color:red;'>NON ce l'hai</p>";
    } else {
        let html = "<p style='color:green;'>CE L'HAI:</p>";
        data.forEach(b => {
            html += `<div class="book"><b>${b.title}</b><br>${b.author}<br>${b.store}</div>`;
        });
        box.innerHTML = html;
    }
};

// AGGIUNGI
document.getElementById("addBtn").onclick = async () => {
    const title = document.getElementById("newTitle").value.trim();
    const author = document.getElementById("newAuthor").value.trim();
    const store = document.getElementById("newStore").value.trim();

    if (!title) return;

    const res = await fetch(API_URL, {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({ title, author, store })
    });

    const out = await res.json();

    document.getElementById("addStatus").innerHTML =
        `<p style="color:blue;">Libro aggiunto!</p>`;
};

// LISTA LIBRI
async function loadBooks() {
    const res = await fetch(API_URL);
    const data = await res.json();
    let html = "";

    data.forEach(b => {
        html += `
            <div class="book">
                <b>${b.title}</b><br>
                ${b.author}<br>
                ${b.store}<br>
                <button class="delete-btn" onclick="deleteBook('${b.id}')">Elimina</button>
            </div>
        `;
    });

    document.getElementById("bookList").innerHTML = html;
}

document.getElementById("refreshBtn").onclick = loadBooks;

async function deleteBook(id) {
    await fetch(API_URL + "?id=" + id, { method: "DELETE" });
    loadBooks();
}

loadBooks();
</script>

</body>
</html>
