<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Gestione Libri</title>
<style>
body { font-family: Arial; padding: 20px; text-align: center; }
input, button { width: 90%; padding: 10px; margin:5px 0; font-size: 18px; border-radius: 8px; border:1px solid #888; }
#result { font-size: 18px; padding: 15px; text-align: left; white-space: pre-line; max-width: 500px; margin:auto;}
.bookList { text-align: left; max-width: 500px; margin:auto; margin-top: 20px;}
.bookItem { border-bottom: 1px solid #ccc; padding:5px;}
button.small { padding: 3px 8px; font-size:14px; margin-left:5px;}
</style>
</head>
<body>

<h2>Libri</h2>

<h3>Cerca libro</h3>
<input id="searchTitle" placeholder="Titolo">
<button onclick="checkBook()">Cerca</button>
<div id="result"></div>

<hr>

<h3>Aggiungi libro</h3>
<input id="newTitle" placeholder="Titolo">
<input id="newAuthor" placeholder="Autore">
<input id="newPublisher" placeholder="Casa editrice (opzionale)">
<button onclick="addBook()">Aggiungi libro</button>

<hr>

<h3>Elenco libri</h3>
<div id="bookList"></div>

<script type="module">
// Firebase SDK
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-app.js";
import { getDatabase, ref, push, onValue, remove, update } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-database.js";

// Config Firebase
const firebaseConfig = {
  apiKey: "AIzaSyBf-7Tg24C63gEVJEVkAyVqeci_WQ-BL9k",
  authDomain: "controlloordini-165ec.firebaseapp.com",
  databaseURL: "https://controlloordini-165ec-default-rtdb.firebaseio.com",
  projectId: "controlloordini-165ec",
  storageBucket: "controlloordini-165ec.appspot.com",
  messagingSenderId: "825748031202",
  appId: "1:825748031202:web:61cb4cca7511df87a280bb"
};

// Inizializza Firebase
const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
const booksRef = ref(db, 'books');

// Funzione aggiungi libro
window.addBook = () => {
  const t = document.getElementById("newTitle").value.trim();
  const a = document.getElementById("newAuthor").value.trim();
  const p = document.getElementById("newPublisher").value.trim();
  if(!t || !a){ alert("Titolo e Autore obbligatori!"); return; }
  push(booksRef, { title: t, author: a, publisher: p, arrived:false });
  document.getElementById("newTitle").value="";
  document.getElementById("newAuthor").value="";
  document.getElementById("newPublisher").value="";
  alert("Libro aggiunto!");
};

// Funzione ricerca libri
window.checkBook = () => {
  const search = document.getElementById("searchTitle").value.trim().toLowerCase();
  const resultDiv = document.getElementById("result");
  if(!search){ resultDiv.textContent=""; return; }
  onValue(booksRef, snapshot => {
    const data = snapshot.val() || {};
    const found = Object.values(data).filter(b => b.title.toLowerCase().includes(search));
    if(found.length === 0){
      resultDiv.textContent = "Nessun libro trovato ❌";
    } else {
      let out = "Libri trovati ✅\n\n";
      found.forEach(b => {
        out += `Titolo: ${b.title}\nAutore: ${b.author}\n${b.publisher ? "Casa editrice: "+b.publisher+"\n":""}Arrivato: ${b.arrived ? "✅":"❌"}\n\n`;
      });
      resultDiv.textContent = out;
    }
  }, {onlyOnce:true});
};

// Aggiorna checkbox Arrivato
window.toggleArrived = (id, val) => {
  update(ref(db, 'books/' + id), { arrived: val });
};

// Elimina libro
window.deleteBook = (id) => {
  if(confirm("Vuoi eliminare questo libro?")){
    remove(ref(db, 'books/' + id));
  }
};

// Render lista completa in tempo reale
function renderList(books){
  const listDiv = document.getElementById("bookList");
  listDiv.innerHTML = "";
  for(let id in books){
    const b = books[id];
    const div = document.createElement("div");
    div.className="bookItem";
    div.innerHTML = `
      ${b.title} — ${b.author} ${b.publisher ? "- "+b.publisher : ""}
      <input type="checkbox" ${b.arrived ? "checked" : ""} onchange="toggleArrived('${id}', this.checked)"> Arrivato
      <button class="small" onclick="deleteBook('${id}')">Elimina</button>
    `;
    listDiv.appendChild(div);
  }
}

// Aggiornamento automatico lista
onValue(booksRef, snapshot => {
  renderList(snapshot.val() || {});
});

</script>
</body>
</html>
