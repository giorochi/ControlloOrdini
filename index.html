<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Gestione Libri</title>
<style>
body { font-family: Arial; padding: 20px; text-align: center; }
input, button { width: 90%; padding: 10px; margin:5px 0; font-size: 18px; border-radius: 8px; border:1px solid #888; }
#result { font-size: 18px; padding: 15px; text-align: left; white-space: pre-line; max-width: 500px; margin:auto;}
.bookList { text-align: left; max-width: 500px; margin:auto; margin-top: 20px;}
.bookItem { border-bottom: 1px solid #ccc; padding:5px;}
button.small { padding: 3px 8px; font-size:14px; margin-left:5px;}
</style>
</head>
<body>

<h2>Libri</h2>

<h3>Cerca libro</h3>
<input id="searchTitle" placeholder="Titolo">
<button id="searchBtn">Cerca</button>
<div id="result"></div>

<hr>

<h3>Aggiungi libro</h3>
<input id="newTitle" placeholder="Titolo">
<input id="newAuthor" placeholder="Autore">
<input id="newPublisher" placeholder="Casa editrice (opzionale)">
<button id="addBtn">Aggiungi libro</button>

<hr>

<h3>Elenco libri</h3>
<div id="bookList"></div>

<!-- Firebase SDK -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-app.js";
import { getDatabase, ref, set, push, onValue, remove, update } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyBf-7Tg24C63gEVJEVkAyVqeci_WQ-BL9k",
  authDomain: "controlloordini-165ec.firebaseapp.com",
  databaseURL: "https://controlloordini-165ec-default-rtdb.firebaseio.com",
  projectId: "controlloordini-165ec",
  storageBucket: "controlloordini-165ec.appspot.com",
  messagingSenderId: "825748031202",
  appId: "1:825748031202:web:61cb4cca7511df87a280bb"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
const booksRef = ref(db, 'books');

// FUNZIONI
window.addBook = () => {
  const title = document.getElementById("newTitle").value.trim();
  const author = document.getElementById("newAuthor").value.trim();
  const publisher = document.getElementById("newPublisher").value.trim();
  if(!title || !author){ alert("Titolo e Autore obbligatori!"); return; }
  push(booksRef, { title, author, publisher, arrived:false });
  document.getElementById("newTitle").value="";
  document.getElementById("newAuthor").value="";
  document.getElementById("newPublisher").value="";
  alert("Libro aggiunto!");
};

window.checkBook = () => {
  const search = document.getElementById("searchTitle").value.trim().toLowerCase();
  const resultDiv = document.getElementById("result");
  if(!search){ resultDiv.textContent=""; return; }
  onValue(booksRef, snapshot => {
    const data = snapshot.val() || {};
    const found = Object.values(data).filter(b => b.title.toLowerCase().includes(search));
    if(found.length===0){
      resultDiv.textContent="Nessun libro trovato ❌";
    } else {
      let out="Libri trovati ✅\n\n";
      found.forEach(b => {
        out += `Titolo: ${b.title}\nAutore: ${b.author}\n${b.publisher ? "Casa editrice: "+b.publisher+"\n":""}Arrivato: ${b.arrived ? "✅":"❌"}\n\n`;
      });
      resultDiv.textContent = out;
    }
  }, {onlyOnce:true});
};

window.updateArrived = (key, val) => {
  update(ref(db, 'books/' + key), { arrived: val });
};

window.deleteBook = (key) => {
  if(confirm("Vuoi eliminare questo libro?")){
    remove(ref(db, 'books/' + key));
  }
};

// Render lista completa
function renderList(books){
  const listDiv = document.getElementById("bookList");
  listDiv.innerHTML = "";
  for(let key in books){
    const b = books[key];
    const div = document.createElement("div");
    div.className = "bookItem";
    div.innerHTML = `
      ${b.title} — ${b.author} ${b.publisher ? "- " + b.publisher : ""}
      <input type="checkbox" ${b.arrived ? "checked" : ""} onchange="updateArrived('${key}', this.checked)"> Arrivato
      <button class="small" onclick="deleteBook('${key}')">Elimina</button>
    `;
    listDiv.appendChild(div);
  }
}

// Aggiornamento in tempo reale della lista
onValue(booksRef, snapshot => {
  renderList(snapshot.val() || {});
});

// EventListener per pulsanti
document.getElementById("addBtn").addEventListener("click", addBook);
document.getElementById("searchBtn").addEventListener("click", checkBook);
</script>

</body>
</html>
