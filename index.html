<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Controllo Ordini Libri</title>
<style>
  body{font-family:Arial,system-ui;padding:18px;max-width:720px;margin:auto}
  input,button{width:100%;padding:10px;margin:6px 0;border-radius:8px;border:1px solid #888;font-size:16px}
  .row{display:flex;gap:8px}
  .small{width:30%}
  .book{border:1px solid #ddd;padding:10px;border-radius:8px;margin:8px 0}
  .actions{display:flex;gap:8px;margin-top:8px}
  .btn-danger{background:#c0392b;color:#fff;border:none;padding:8px;border-radius:6px;cursor:pointer}
  .badge{display:inline-block;padding:4px 8px;border-radius:6px;background:#eee;margin-left:6px}
  #status{margin:6px 0;color:green}
</style>
</head>
<body>
<h2>Controllo Ordini — Cerca / Aggiungi / Elimina</h2>

<!-- Ricerca -->
<input id="searchInput" placeholder="Cerca titolo e premi Invio" />
<div id="searchResults"></div>

<hr>

<!-- Aggiungi -->
<input id="title" placeholder="Titolo" />
<input id="author" placeholder="Autore" />
<input id="store" placeholder="Libreria / Dove comprato" />
<button id="addBtn">Aggiungi libro</button>
<div id="status"></div>

<hr>
<h3>Elenco completo</h3>
<div id="list"></div>

<script type="module">

  /* ---------------------------------------------------
     CONFIG FIREBASE (IL TUO)
  --------------------------------------------------- */
  const firebaseConfig = {
    apiKey: "AIzaSyBf-7Tg24C63gEVJEVkAyVqeci_WQ-BL9k",
    authDomain: "controlloordini-165ec.firebaseapp.com",
    projectId: "controlloordini-165ec",
    storageBucket: "controlloordini-165ec.firebasestorage.app",
    messagingSenderId: "825748031202",
    appId: "1:825748031202:web:61cb4cca7511df87a280bb",
    measurementId: "G-F5GR79DLMN"
  };

  /* ---------------------------------------------------
     SDK FIREBASE IMPORT
  --------------------------------------------------- */
  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
  import {
    getFirestore, collection, addDoc, deleteDoc, doc,
    onSnapshot, query, orderBy, getDocs
  } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js";

  // Init Firebase + Firestore
  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  const booksCol = collection(db, "books");

  // UI refs
  const searchInput = document.getElementById("searchInput");
  const searchResults = document.getElementById("searchResults");
  const listDiv = document.getElementById("list");
  const addBtn = document.getElementById("addBtn");
  const statusDiv = document.getElementById("status");

  /* ---------------------------------------------------
     AGGIUNTA LIBRO
  --------------------------------------------------- */
  addBtn.onclick = async () => {
    const title = document.getElementById("title").value.trim();
    const author = document.getElementById("author").value.trim();
    const store = document.getElementById("store").value.trim();

    if (!title || !author || !store) {
      statusDiv.style.color = "red";
      statusDiv.textContent = "Compila tutti i campi";
      return;
    }

    statusDiv.style.color = "black";
    statusDiv.textContent = "Invio...";

    try {
      await addDoc(booksCol, {
        title, author, store, arrived: false, ts: Date.now()
      });

      statusDiv.style.color = "green";
      statusDiv.textContent = "Libro aggiunto!";
      document.getElementById("title").value = "";
      document.getElementById("author").value = "";
      document.getElementById("store").value = "";

      setTimeout(()=> statusDiv.textContent = "", 2000);
    } catch (e) {
      statusDiv.style.color = "red";
      statusDiv.textContent = "Errore";
      console.error(e);
    }
  };

  /* ---------------------------------------------------
     LISTA LIVE
  --------------------------------------------------- */
  const q = query(booksCol, orderBy("ts", "desc"));
  onSnapshot(q, snapshot => {
    const docs = [];
    snapshot.forEach(d => docs.push({ id: d.id, ...d.data() }));
    renderList(docs);

    if (searchInput.value.trim()) doSearch(searchInput.value.trim(), docs);
  });

  function renderList(items){
    listDiv.innerHTML = "";
    items.forEach(b => {
      const div = document.createElement("div");
      div.className = "book";
      div.innerHTML = `<b>${escapeHtml(b.title)}</b>
        <div>Autore: ${escapeHtml(b.author)} — Libreria: ${escapeHtml(b.store)}</div>
        <div class="actions">
          <button class="btn-danger" data-id="${b.id}">Elimina</button>
        </div>`;
      listDiv.appendChild(div);

      div.querySelector("button").onclick = async () => {
        if (!confirm("Eliminare questo libro?")) return;
        await deleteDoc(doc(db, "books", b.id));
      };
    });
  }

  /* ---------------------------------------------------
     RICERCA
  --------------------------------------------------- */
  searchInput.addEventListener("keydown", async (e) => {
    if (e.key === "Enter") {
      const qv = searchInput.value.trim();
      if (!qv) { searchResults.innerHTML = ""; return; }

      const snapshot = await getDocs(q);
      const all = [];
      snapshot.forEach(d => all.push({ id: d.id, ...d.data() }));

      doSearch(qv, all);
    }
  });

  function doSearch(qv, allItems){
    const qlow = qv.toLowerCase();
    const found = allItems.filter(b => b.title.toLowerCase().includes(qlow));

    if (found.length === 0) {
      searchResults.innerHTML = `<p style="color:red">NON CE L'HAI</p>`;
      return;
    }

    let html = "<p style='color:green'>Trovati:</p>";
    found.forEach(b => {
      html += `<div class="book"><b>${escapeHtml(b.title)}</b>
        <div>Autore: ${escapeHtml(b.author)} — Libreria: ${escapeHtml(b.store)}</div></div>`;
    });

    searchResults.innerHTML = html;
  }

  /* ---------------------------------------------------
     SAFE TEXT
  --------------------------------------------------- */
  function escapeHtml(str){
    return String(str).replace(/[&<>"']/g, s=>({
      "&": "&amp;",
      "<": "&lt;",
      ">": "&gt;",
      "\"": "&quot;",
      "'": "&#39;"
    })[s]);
  }

  searchInput.focus();

</script>
</body>
</html>
